
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>openbci_stream.acquisition.binary_stream &#8212; OpenBCI-Stream  documentation</title>
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/custom.css" />
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="shortcut icon" href="../../../_static/favico.ico"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for openbci_stream.acquisition.binary_stream</h1><div class="highlight"><pre>
<span></span>&quot;&quot;&quot;
=============
Binary stream
=============

This module must be run in the same machine that OpenBCI hardware was attached.
&quot;&quot;&quot;

import pickle
import logging
from datetime import datetime
from typing import Dict, Any

from kafka import KafkaProducer


########################################################################
<div class="viewcode-block" id="BinaryStream"><a class="viewcode-back" href="../../openbci_stream.acquisition.binary_stream.html#openbci_stream.acquisition.binary_stream.BinaryStream">[docs]</a>class BinaryStream:
    &quot;&quot;&quot;Kafka producer for equal size packages streaming.

    The dictionary streamed contain two objects: `data` and `context`.

    **data:** Bytes with binary raw data.

    **context:** A dictionary with the following keys:

    * **created:**  The `timestamp` for the exact moment when binary data was read.
    * **daisy:** `True` if Daisy board is attached, otherwise `False`.
    * **boardmode:** Can be `default`, `digital`, &#39;&#39;analog&#39;, &#39;debug&#39; or `marker`.
    * **montage:** A list means consecutive channels e.g. `[&#39;Fp1&#39;, &#39;Fp2&#39;, &#39;F3&#39;, &#39;Fz&#39;, &#39;F4&#39;]` and a dictionary means specific channels  `{1: &#39;Fp1&#39;, 2: &#39;Fp2&#39;, 3: &#39;F3&#39;, 4: &#39;Fz&#39;, 5: &#39;F4&#39;}`.
    * **connection:** Can be `serial` or `wifi`.
    * **gain:** Array with gains.

    e.g

    &gt;&gt;&gt; context = {&#39;created&#39;: 1604196938.727064,
                   &#39;daisy&#39;: False,
                   &#39;boardmode&#39;: &#39;default&#39;,
                   &#39;montage&#39;: [&#39;Fp1&#39;, &#39;Fp2&#39;, &#39;F3&#39;, &#39;Fz&#39;, &#39;F4&#39;],
                   &#39;connection&#39;: &#39;wifi&#39;,
                   &#39;gain&#39;: [24, 24, 24, 24, 24, 24, 24, 24]
                   }
    &quot;&quot;&quot;

    TOPIC = &#39;binary&#39;
    accumulated = b&#39;&#39;

    # ----------------------------------------------------------------------
<div class="viewcode-block" id="BinaryStream.__init__"><a class="viewcode-back" href="../../openbci_stream.acquisition.binary_stream.html#openbci_stream.acquisition.binary_stream.BinaryStream.__init__">[docs]</a>    def __init__(self, streaming_package_size: int) -&gt; None:
        &quot;&quot;&quot;
        Parameters
        ----------
        streaming_package_size
            The package size for streaming packages.
        &quot;&quot;&quot;

        logging.info(f&#39;Creating {self.TOPIC} Produser&#39;)
        self.streaming_package_size = streaming_package_size
        self.producer = KafkaProducer(bootstrap_servers=[&#39;localhost:9092&#39;],
                                      compression_type=&#39;gzip&#39;,
                                      value_serializer=pickle.dumps,
                                      )</div>

    # ----------------------------------------------------------------------
<div class="viewcode-block" id="BinaryStream.stream"><a class="viewcode-back" href="../../openbci_stream.acquisition.binary_stream.html#openbci_stream.acquisition.binary_stream.BinaryStream.stream">[docs]</a>    def stream(self, data: Dict[str, Any]) -&gt; None:
        &quot;&quot;&quot;This stream attempts to create packages of the same size.

        Over WiFi and Daisy, the sampling frequency is doubled in favor to get
        all 16 channels, so the size of the packages is also doubled.

        Parameters
        ----------
        data
            Dictionary with context and raw binary data.
        &quot;&quot;&quot;
        self.accumulated += data[&#39;data&#39;]

        if data[&#39;context&#39;][&#39;connection&#39;] == &#39;wifi&#39; and data[&#39;context&#39;][&#39;daisy&#39;]:
            f = 2
        else:
            f = 1
        size = self.streaming_package_size * 33 * f

        if len(self.accumulated) &gt;= size:
            data[&#39;data&#39;] = self.accumulated[:size]
            # data[&#39;context&#39;][&#39;created&#39;] = datetime.now().timestamp()
            self.producer.send(self.TOPIC, data)
            self.accumulated = self.accumulated[size:]</div>

    # ----------------------------------------------------------------------
<div class="viewcode-block" id="BinaryStream.close"><a class="viewcode-back" href="../../openbci_stream.acquisition.binary_stream.html#openbci_stream.acquisition.binary_stream.BinaryStream.close">[docs]</a>    def close(self) -&gt; None:
        &quot;&quot;&quot;Terminate the produser.&quot;&quot;&quot;
        logging.info(f&#39;Clossing {self.TOPIC} Produser&#39;)
        self.producer.close(timeout=0.3)</div></div>


</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/logo.svg" alt="Logo"/>
            </a></p>
<h3><a href="../../../index.html">Table of Contents</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/00-installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/01-hardware_configurations.html">Hardware configurations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/02-kafka_configuration.html">Kafka configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/03-data_acquisition.html">Data Acquisition</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/04-board_modes.html">Board modes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/05-stream_markers.html">Stream markers with Kafka</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/06-command_line_interface.html">Command line interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/07-data_storage_handler.html">Data storage handler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/A1-raw_cleaning.html">Appendix 1 - Raw data processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/A2-electrodes_impedance.html">Appendix 2 - Measuring Electrode Impedance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/A3-server-based_acquisition.html">Appendix 3 - Raspberry PI as server acquisition</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/A4-latencies.html">Appendix 4 - System latencies</a></li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019-2021, Yeison Cardona.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.5.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>